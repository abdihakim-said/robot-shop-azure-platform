#cloud-config
package_update: true
package_upgrade: true

packages:
  - curl
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release

runcmd:
  # Install Azure CLI
  - curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
  
  # Install kubectl
  - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
  - sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
  
  # Install Helm
  - curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
  - sudo apt-get update
  - sudo apt-get install helm
  
  # Configure kubectl for AKS (will need manual login)
  - echo "# Run these commands after SSH login:" > /home/azureuser/setup-kubectl.sh
  - echo "az login" >> /home/azureuser/setup-kubectl.sh
  - echo "az aks get-credentials --resource-group ${aks_resource_group_name} --name ${aks_cluster_name}" >> /home/azureuser/setup-kubectl.sh
  - chmod +x /home/azureuser/setup-kubectl.sh
  - chown azureuser:azureuser /home/azureuser/setup-kubectl.sh

write_files:
  - path: /home/azureuser/README.md
    content: |
      # Kubectl Access VM
      
      This VM provides secure access to the private AKS cluster via Azure Bastion.
      
      ## Setup Steps:
      1. Run: ./setup-kubectl.sh
      2. Follow Azure login prompts
      3. Verify: kubectl get nodes
      
      ## Available Tools:
      - kubectl (Kubernetes CLI)
      - helm (Package manager)
      - az (Azure CLI)
    owner: azureuser:azureuser
    permissions: '0644'
