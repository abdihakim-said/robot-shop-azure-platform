name: PR Validation (Simplified)

on:
  pull_request:
    branches: [develop, 'release/**', main]
    paths:
      - 'web/**'
      - 'cart/**'
      - 'catalogue/**'
      - 'user/**'
      - 'payment/**'
      - 'shipping/**'
      - 'ratings/**'
      - 'dispatch/**'
      - 'mysql/**'
      - 'mongo/**'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Service Changes
        id: changes
        uses: ./.github/actions/detect-service-changes
        with:
          base-sha: ${{ github.event.pull_request.base.sha }}
          head-sha: ${{ github.event.pull_request.head.sha }}

  security-scan:
    name: Security Scan
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    uses: ./.github/workflows/security-scan.yml
    with:
      services: ${{ needs.detect-changes.outputs.services }}
      scan-type: 'pr'
      fail-on-critical: false

  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-changes == 'true'
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          cd ${{ matrix.service }}
          docker build -t ${{ matrix.service }}:pr-${{ github.event.pull_request.number }} .

      - name: Container Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.service }}:pr-${{ github.event.pull_request.number }}
          format: 'sarif'
          output: 'trivy-image-${{ matrix.service }}.sarif'
      
      - name: Upload Scan Results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-image-${{ matrix.service }}.sarif'
          category: 'pr-container-${{ matrix.service }}'

  pr-summary:
    name: PR Summary
    needs: [detect-changes, security-scan, build-verification]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const services = ${{ needs.detect-changes.outputs.services || '[]' }};
            const hasChanges = '${{ needs.detect-changes.outputs.has-changes }}' === 'true';
            const securityResult = '${{ needs.security-scan.result }}';
            const buildResult = '${{ needs.build-verification.result }}';
            
            let summary = '## üîç PR Validation Results\n\n';
            
            if (!hasChanges) {
              summary += '‚úÖ No service changes detected\n';
            } else {
              summary += `**Services Changed:** ${services.join(', ')}\n\n`;
              summary += `**Security Scan:** ${securityResult === 'success' ? '‚úÖ Passed' : '‚ö†Ô∏è Issues Found'}\n`;
              summary += `**Build Verification:** ${buildResult === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}\n\n`;
              
              if (buildResult === 'success') {
                summary += '‚úÖ **Ready for merge**\n';
              } else {
                summary += '‚ùå **Build issues - Review required**\n';
              }
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });