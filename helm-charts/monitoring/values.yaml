# Monitoring chart values
prometheus:
  enabled: true  # Enable the full stack since operator is in Terraform

# Configure the monitoring stack (operator already installed via Terraform)
kube-prometheus-stack:
  prometheus:
    enabled: true
    prometheusSpec:
      serviceMonitorSelectorNilUsesHelmValues: false
      ruleSelectorNilUsesHelmValues: false
  
  alertmanager:
    enabled: true
  
  grafana:
    enabled: true
    
    # ServiceAccount configuration will be handled by ArgoCD parameters
    extraVolumes:
      - name: grafana-secrets-store
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: grafana-secrets
    extraVolumeMounts:
      - name: grafana-secrets-store
        mountPath: /mnt/secrets-store
        readOnly: true
    # Use environment variables to read from mounted secrets
    
    # ServiceAccount configuration will be handled by ArgoCD parameters
    extraVolumes:
      - name: grafana-secrets-store
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: grafana-secrets
    extraVolumeMounts:
      - name: grafana-secrets-store
        mountPath: /mnt/secrets-store
        readOnly: true
      - name: azure-identity-token
        mountPath: /var/run/secrets/azure/tokens
        readOnly: true
    # Use environment variables to read from mounted secrets
    extraEnvVars:
      - name: GF_SECURITY_ADMIN_USER
        valueFrom:
          secretKeyRef:
            name: grafana-admin-secret
            key: admin-user
      - name: GF_SECURITY_ADMIN_PASSWORD
        valueFrom:
          secretKeyRef:
            name: grafana-admin-secret
            key: admin-password
    # Password will be retrieved from Key Vault via SecretProviderClass
    admin:
      existingSecret: "grafana-admin-secret"
      userKey: "admin-user"
      passwordKey: "admin-password"
  
  prometheusOperator:
    enabled: false  # Already installed via Terraform - CRITICAL: Avoid conflict
  
  # Node exporter configuration - fix for Azure AKS system nodes
  prometheus-node-exporter:
    # Override AWS-specific affinity with simple Linux requirement
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: kubernetes.io/os
              operator: In
              values:
              - linux
    # Add toleration for system nodes with CriticalAddonsOnly taint
    tolerations:
      - key: CriticalAddonsOnly
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
