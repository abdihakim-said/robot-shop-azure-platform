# Cluster Autoscaler Configuration for AKS
# Managed via GitOps with ArgoCD

# Global configuration
global:
  environment: dev

# Cluster Autoscaler specific configuration
cluster-autoscaler:
  # AKS-specific configuration
  cloudProvider: azure
  
  # Azure configuration
  azureResourceGroup: robot-shop-dev-rg
  azureSubscriptionID: "" # Will be set via ArgoCD parameters
  azureVMType: "AKS"
  azureClusterName: robot-shop-dev-aks
  azureNodeResourceGroup: "" # Auto-detected by AKS
  
  # Scaling configuration
  autoscalingGroups:
    - name: agentpool
      minSize: 2
      maxSize: 6
  
  # Scaling behavior
  scaleDownDelayAfterAdd: "10m"
  scaleDownDelayAfterDelete: "10s"
  scaleDownDelayAfterFailure: "3m"
  scaleDownUnneededTime: "10m"
  scaleDownUtilizationThreshold: 0.5
  
  # Resource requests/limits
  resources:
    requests:
      cpu: 100m
      memory: 300Mi
    limits:
      cpu: 100m
      memory: 300Mi
  
  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534
  
  # Node selector for system nodes
  nodeSelector:
    kubernetes.io/os: linux
  
  # Tolerations for system nodes
  tolerations:
    - key: CriticalAddonsOnly
      operator: Exists
    - effect: NoSchedule
      key: node-role.kubernetes.io/master
  
  # Service account with proper RBAC
  rbac:
    create: true
    serviceAccount:
      create: true
      name: cluster-autoscaler
      annotations:
        # Azure Workload Identity (if using)
        azure.workload.identity/client-id: ""
  
  # Monitoring and observability
  serviceMonitor:
    enabled: true
    namespace: kube-system
  
  # Logging
  verbosity: 4
  logToStderr: true
  
  # Additional arguments for AKS
  extraArgs:
    - --balance-similar-node-groups=true
    - --skip-nodes-with-local-storage=false
    - --skip-nodes-with-system-pods=false
    - --scale-down-enabled=true
    - --scale-down-delay-after-add=10m
    - --scale-down-unneeded-time=10m
    - --max-node-provision-time=15m
    - --node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/robot-shop-dev-aks
