# Global values override individual chart values - Templated from Terraform outputs
global:
  imageRegistry: {{ .Values.terraform.acr_login_server | default "robotshopacr.azurecr.io" }}
  imageTag: {{ .Values.terraform.image_tag | default "tested-v20251223-d5d1466" }}
  imagePullPolicy: Always
  environment: dev
  
  # Global ingress configuration for umbrella chart
  ingress:
    enabled: true
    className: nginx
    annotations:
      nginx.ingress.kubernetes.io/rewrite-target: /
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - host: hakimdevops.art
        paths:
          - path: /
            pathType: Prefix
            service: web
            port: 8080
    tls:
      - secretName: hakimdevops-art-tls
        hosts:
          - hakimdevops.art
  
  # Azure Key Vault integration - Dynamic from Terraform
  azure:
    keyVaultName: {{ .Values.terraform.key_vault_name | default "robot-shop-dev-kv" | quote }}
    managedIdentityClientId: {{ .Values.terraform.managed_identity_client_id | default "" | quote }}
    tenantId: {{ .Values.terraform.tenant_id | default "" | quote }}
    managedIdentityClientId: "{{ .Values.azure.managedIdentityClientId }}"
  
  # Database security (retrieved from Key Vault)
  mysql:
    rootPassword: ""  # Retrieved from Key Vault
    userPassword: ""  # Retrieved from Key Vault

# Azure Key Vault integration
keyVault:
  enabled: true
  secretProviderClass: mongodb-secrets

# Individual services inherit from global
cart:
  enabled: true
  autoscaling:
    enabled: true
    minReplicas: 2  # Changed from 1 to enable VPA Auto mode
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "5m"
    maxCpu: "100m"
    minMemory: "32Mi"
    maxMemory: "128Mi"
  image:
    tag: "v20251230-2dd5359"
catalogue:
  enabled: true
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "5m"
    maxCpu: "100m"
    minMemory: "32Mi"
    maxMemory: "128Mi"
  image:
    tag: "v20251227-59987d7"
user:
  enabled: true
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "5m"
    maxCpu: "100m"
    minMemory: "32Mi"
    maxMemory: "128Mi"
  image:
    tag: "v20251230-61ae855"
payment:
  enabled: true
  autoscaling:
    enabled: true
    minReplicas: 2  # Changed from 1 to enable VPA Auto mode
    maxReplicas: 3
    targetCPUUtilizationPercentage: 60
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "5m"
    maxCpu: "100m"
    minMemory: "32Mi"
    maxMemory: "128Mi"
  image:
    tag: "v20260102-54e01e3"
shipping:
  enabled: true
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "5m"
    maxCpu: "200m"
    minMemory: "64Mi"
    maxMemory: "512Mi"
  image:
    tag: "v20251225-66ff23c"
ratings:
  enabled: true
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "5m"
    maxCpu: "100m"
    minMemory: "32Mi"
    maxMemory: "128Mi"
  image:
    tag: "v20251223-f9c148e"
dispatch:
  enabled: true
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "5m"
    maxCpu: "50m"
    minMemory: "16Mi"
    maxMemory: "64Mi"
  image:
    tag: "v20251227-bc54ffa"
# Infrastructure services
# Infrastructure services
redis:
  enabled: true
  replicas: 1  # Force single replica for cache
  autoscaling:
    enabled: false  # Disable HPA for cache (needs Redis Cluster for HA)
    minReplicas: 1
    maxReplicas: 1
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "5m"
    maxCpu: "100m"
    minMemory: "16Mi"
    maxMemory: "128Mi"
  service:
    type: ClusterIP
    port: 6379
  auth:
    enabled: true
  resources:
    requests:
      cpu: 20m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 64Mi

web:
  enabled: true
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "5m"
    maxCpu: "200m"
    minMemory: "32Mi"
    maxMemory: "128Mi"
  replicas: 1
  service:
    type: ClusterIP
  ingress:
    enabled: false
  resources:
    requests:
      cpu: 30m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi
  monitoring:
    enabled: true
  image:
    tag: "v20260104-d80b940"

# Infrastructure services configuration
mysql:
  enabled: true
  autoscaling:
    enabled: false  # Disable HPA for stateful database
    minReplicas: 1
    maxReplicas: 1
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "10m"
    maxCpu: "300m"
    minMemory: "256Mi"
    maxMemory: "1Gi"
  image:
    tag: "v20251225-b261c8b"
  replicas: 1
  service:
    type: ClusterIP
  # Security: Passwords retrieved from Azure Key Vault
  auth:
    useKeyVault: true
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

mongodb:
  enabled: true
  replicas: 1  # Force single replica for stateful database
  autoscaling:
    enabled: false  # Disable HPA for stateful database
    minReplicas: 1
    maxReplicas: 1
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "10m"
    maxCpu: "300m"
    minMemory: "128Mi"
    maxMemory: "512Mi"
  service:
    type: ClusterIP
    port: 27017
  image:
    repository: {{ .Values.global.imageRegistry | default "robotshopacr.azurecr.io" }}/mongo
    tag: "v20251227-a94e952"
  keyVault:
    enabled: true
  auth:
    enabled: true  # Enable auth to match Azure Key Vault integration
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

rabbitmq:
  enabled: true
  replicas: 1  # Force single replica for message queue
  autoscaling:
    enabled: false  # Disable HPA for message queue (needs cluster configuration)
    minReplicas: 1
    maxReplicas: 1
    targetCPUUtilizationPercentage: 70
  vpa:
    enabled: true
    updateMode: "Auto"
    minCpu: "10m"
    maxCpu: "200m"
    minMemory: "64Mi"
    maxMemory: "256Mi"
  service:
    type: ClusterIP
    port: 5672
  auth:
    username: admin
    password: ""  # Retrieved from Azure Key Vault
  resources:
    requests:
      cpu: 30m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 512Mi


