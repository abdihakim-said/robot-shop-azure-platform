apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: robot-shop-slos
  namespace: robot-shop
  labels:
    app: robot-shop
    release: monitoring
spec:
  groups:
  - name: robot-shop.slos
    rules:
    # SLI: Service Availability (HTTP 2xx responses)
    - record: robot_shop:availability_sli
      expr: |
        (
          sum(rate(http_requests_total{namespace="robot-shop",code=~"2.."}[5m])) /
          sum(rate(http_requests_total{namespace="robot-shop"}[5m]))
        ) * 100
    
    # SLI: Response Time (95th percentile < 500ms)
    - record: robot_shop:latency_sli
      expr: |
        (
          sum(rate(http_request_duration_seconds_bucket{namespace="robot-shop",le="0.5"}[5m])) /
          sum(rate(http_request_duration_seconds_count{namespace="robot-shop"}[5m]))
        ) * 100
    
    # SLI: Business Success Rate (successful payments)
    - record: robot_shop:business_success_sli
      expr: |
        (
          sum(rate(sold_count{namespace="robot-shop"}[5m])) /
          sum(rate(items_added{namespace="robot-shop"}[5m]))
        ) * 100

  - name: robot-shop.alerts
    rules:
    # SLO Alert: Availability < 99.9% (Error Budget: 0.1%)
    - alert: RobotShopAvailabilitySLOBreach
      expr: robot_shop:availability_sli < 99.9
      for: 5m
      labels:
        severity: critical
        slo: availability
      annotations:
        summary: "Robot Shop availability SLO breach"
        description: "Availability is {{ $value }}%, below 99.9% SLO"
    
    # SLO Alert: Latency SLI < 95% (5% of requests > 500ms)
    - alert: RobotShopLatencySLOBreach
      expr: robot_shop:latency_sli < 95
      for: 5m
      labels:
        severity: warning
        slo: latency
      annotations:
        summary: "Robot Shop latency SLO breach"
        description: "{{ $value }}% of requests under 500ms, below 95% SLO"
    
    # Business Alert: Conversion rate drop
    - alert: RobotShopConversionDrop
      expr: robot_shop:business_success_sli < 10
      for: 10m
      labels:
        severity: warning
        slo: business
      annotations:
        summary: "Robot Shop conversion rate critically low"
        description: "Conversion rate is {{ $value }}%, investigate checkout flow"
